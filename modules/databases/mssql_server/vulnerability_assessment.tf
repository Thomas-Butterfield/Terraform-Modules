resource "azurerm_mssql_server_vulnerability_assessment" "mssql" {
  count = try(var.settings.security_alert_policy.vulnerability_assessment, null) == null ? 0 : 1

  server_security_alert_policy_id = azurerm_mssql_server_security_alert_policy.mssql.0.id
  storage_container_path          = format("%s%s/", var.storage_accounts[var.settings.security_alert_policy.vulnerability_assessment.sa_key].primary_blob_endpoint, try(var.settings.security_alert_policy.vulnerability_assessment.storage_account.container_path, "mssql_server_vascans"))
  storage_account_access_key      = try(var.storage_accounts[var.settings.security_alert_policy.vulnerability_assessment.sa_key].primary_access_key, null)
  storage_container_sas_key       = try(var.settings.security_alert_policy.vulnerability_assessment.storage_container_sas_key, null)

  dynamic "recurring_scans" {
    for_each = lookup(var.settings.security_alert_policy.vulnerability_assessment, "recurring_scans", {}) == {} ? [] : [1]

    content {
      enabled                   = try(var.settings.security_alert_policy.vulnerability_assessment.recurring_scans.enabled, true)
      email_subscription_admins = try(var.settings.security_alert_policy.vulnerability_assessment.recurring_scans.email_subscription_admins, false)
      emails                    = try(var.settings.security_alert_policy.vulnerability_assessment.recurring_scans.email_addresses, null)
    }
  }

}